# Target Clickhouse

A [Singer](https://singer.io/) target for Clickhouse, for use with Singer streams generated by Singer taps, written in node js
using [singer-node](https://www.npmjs.com/package/singer-node).

## Usage

### Install

#### As npm package on host

`npm install -g target-clickhouse`

#### Docker image

`docker pull biron-bi/target-clickhouse:latest`

### Run

1. Create a [config file](#configjson) `config.json` with connection information and ingestion parameters.

   ```json
   {
     "host": "localhost",
     "port": 8123,
     "database": "destination_database",
     "username": "user",
     "password": "averysecurepassword"
   }
   ```

2. Run `target-clickhouse` against a [Singer](https://singer.io) tap.

Npm package:

   ```bash
   <tap-anything> --state $(tail -n 1 state.jsonl) | target-clickhouse --config config.json >> state.jsonl
   ```

Docker:

   ```bash
   <tap-anything> --state $(tail -n 1 state.jsonl) | docker run --rm -i -a STDIN -a STDOUT -a STDERR -v "{1}:/config:ro" biron-bi/target-clickhouse >> state.jsonl
   ```

### Config.json

The fields available to be specified in the config file.

#### Mandatory fields

* `host`
* `port`
* `username`
* `password`
* `database`

#### Optional fields

* `max_batch_rows` The maximum number of rows to buffer in memory before writing to the destination table in Clickhouse. Default to `1000`
* `max_batch_size` The maximum number of bytes to buffer in memory before writing to the destination table in Postgres. Default to `1048576`
* `logging_level` Default to `"INFO"`

## Singer specification extension

Several features are supported that are not standard to the singer Spec:
* **Update schemas** : Pass the repeatable CLI option ` --update-streams <stream>` to specify streams for which you want to recreate tables (root and children).
* **Clean first** : Specify `clean_first: true` in SCHEMA messages to wipe table content before each ingestion.
* **Cleaning column** : Specify `cleaning_column: "<column_name>"` in SCHEMA messages to wipe table content that matches column value during ingestion. For instance, if column "date" is specified as cleaning column, and the value "2022-01-01" is encountered in a record, all column with values "2022-01-01" are replaced with those contained in the stream
* **All key properties** : Specify `all_key_properties: {props: [], children: {}}` in SCHEMA messages to specify primary keys for all children of a root table. This will allow children to create a foreign key to their parent (with the format `_parent_<column>`)

## Sponsorship

Target Clickhouse is written and maintained by **Biron** https://birondata.com/

## Acknowledgements

Special thanks to the people who built
* [singer](https://github.com/singer-io/getting-started)
* [target-postgres](https://github.com/datamill-co/target-postgres)
* [immutable-js](https://immutable-js.com/)

## License

Copyright Â© 2022 Biron

Distributed under the AGPLv3
